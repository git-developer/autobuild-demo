set -eua

IMAGE_VENDOR="${IMAGE_VENDOR}"
IMAGE_TITLE="${DOCKER_REPO}"
IMAGE_VERSION="${DOCKER_TAG}"
IMAGE_REVISION="${SOURCE_COMMIT}"
IMAGE_CREATED="$(date -u --rfc-3339 seconds)"
IMAGE_REF_NAME="${SOURCE_BRANCH}"

if wget -q --spider "https://api.github.com/repos/${IMAGE_VENDOR}/${IMAGE_TITLE}"; then
  GITHUB_PROJECT_METADATA=$(wget -q -O - https://api.github.com/repos/${IMAGE_VENDOR}/${IMAGE_TITLE})
  GITHUB_OWNER_METADATA=$(wget -q -O - $(echo "${GITHUB_PROJECT_METADATA}" | jq -r '.owner.url'))
  GITHUB_URL="https://github.com/${DOCKER_REPO}"
  GITHUB_DOCUMENTATION="${GITHUB_URL}#readme"
  GITHUB_DESCRIPTION="$(echo "${GITHUB_PROJECT_METADATA}" | jq -r '.description')"
  GITHUB_LICENSE="$(echo "${GITHUB_PROJECT_METADATA}" | jq -r '.license.key')"
  GITHUB_AUTHOR="$(echo "${GITHUB_OWNER_METADATA}" | jq -r '.name') $(echo "${GITHUB_OWNER_METADATA}" | jq -r '.html_url')"

  IMAGE_DESCRIPTION="${GITHUB_DESCRIPTION}"
  IMAGE_URL="${GITHUB_URL}"
  IMAGE_DOCUMENTATION="${GITHUB_DOCUMENTATION}"
  IMAGE_LICENSES="${GITHUB_LICENSE}"
  IMAGE_AUTHORS="${GITHUB_AUTHOR}"
fi

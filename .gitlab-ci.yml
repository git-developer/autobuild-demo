variables:
  DOCKERFILE_PATH: "image/Dockerfile"

stages:
  - prepare
  - build
  - publish
  - build_and_publish

Collect Image Metadata:
  stage: prepare
  variables:
    IMAGE_VERSION:   "latest"
    IMAGE_NAME:      "${CI_PROJECT_PATH}:${IMAGE_VERSION}"
    IMAGE_VENDOR:    "${CI_PROJECT_NAMESPACE}"
    IMAGE_TITLE:     "${CI_PROJECT_TITLE}"
    IMAGE_URL:       "${CI_REPOSITORY_URL}"
    IMAGE_REVISION:  "${CI_COMMIT_SHA}"
    IMAGE_REF_NAME:  "${CI_COMMIT_REF_NAME}"
  script:
    - apt-get -q update && apt-get -q install -y wget jq
    - gitlab_project_metadata="$(wget -q -O - "${CI_SERVER_URL}/api/v4/projects/${CI_PROJECT_ID}?license=yes")"
    - value_of() { echo "${gitlab_project_metadata}" | jq -r "${1} // empty"; }
    - owner_url="$(                 value_of .namespace.web_url)"
    - export IMAGE_LICENSES="$(     value_of .license.key)"
    - export IMAGE_DESCRIPTION="$(  value_of .description)"
    - export IMAGE_DOCUMENTATION="$(value_of .readme_url)"
    - export IMAGE_AUTHORS="${GITLAB_USER_LOGIN}${owner_url:+ <${owner_url}>}"
    - export IMAGE_CREATED="$(date -u --rfc-3339 seconds)"
    - set | grep '^IMAGE_' >image-metadata
  artifacts:
    paths:
    - image-metadata
    expire_in: 1 week

Obtain buildx:
  image: docker:19.03-git
  stage: prepare
  variables:
    GIT_STRATEGY: none
  artifacts:
    paths:
      - buildx
    expire_in: 1 hour
  services:
    - docker:19.03-dind
  script:
    - export DOCKER_BUILDKIT=1
    - git clone git://github.com/docker/buildx ./docker-buildx
    - docker build --platform=local -o . ./docker-buildx

Build with Docker CLI:
  stage: build
  before_script:
    - . image-metadata
    - oci='org.opencontainers.image'
  script:
    - echo docker build \
        --file  "${DOCKERFILE_PATH}" \
        --tag   "${IMAGE_NAME}" \
        --label "${oci}.vendor=${IMAGE_VENDOR}" \
        --label "${oci}.title=${IMAGE_TITLE}" \
        --label "${oci}.version=${IMAGE_VERSION}" \
        ${IMAGE_CREATED:+--label "${oci}.created=${IMAGE_CREATED}"} \
        ${IMAGE_AUTHORS:+--label "${oci}.authors=${IMAGE_AUTHORS}"} \
        ${IMAGE_URL:+--label "${oci}.url=${IMAGE_URL}"} \
        ${IMAGE_DOCUMENTATION:+--label "${oci}.documentation=${IMAGE_DOCUMENTATION}"} \
        ${IMAGE_REVISION:+--label "${oci}.revision=${IMAGE_REVISION}"} \
        ${IMAGE_LICENSES:+--label "${oci}.licenses=${IMAGE_LICENSES}"} \
        ${IMAGE_REF_NAME:+--label "${oci}.ref.name=${IMAGE_REF_NAME}"} \
        ${IMAGE_DESCRIPTION:+--label "${oci}.description=${IMAGE_DESCRIPTION}"} \
        .

Push to Docker Registry:
  stage: publish
  before_script:
    - . image-metadata
  script:
    - echo "CI_REGISTRY_IMAGE=${CI_REGISTRY_IMAGE}"
    - echo docker push "${IMAGE_NAME}"

Build and Push with Kaniko:
  stage: build_and_publish
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - . image-metadata
    - oci='org.opencontainers.image'
  script:
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"username\":\"${CI_REGISTRY_USER}\",\"password\":\"${CI_REGISTRY_PASSWORD}\"}}}" >/kaniko/.docker/config.json
    - /kaniko/executor \
        --no-push \
        --context . \
        --dockerfile "${CI_PROJECT_DIR}/${DOCKERFILE_PATH}" \
        --destination "${CI_REGISTRY_IMAGE}:${IMAGE_VERSION}" \
        --label "${oci}.vendor=${IMAGE_VENDOR}" \
        --label "${oci}.title=${IMAGE_TITLE}" \
        --label "${oci}.version=${IMAGE_VERSION}" \
        ${IMAGE_CREATED:+--label "${oci}.created=${IMAGE_CREATED}"} \
        ${IMAGE_AUTHORS:+--label "${oci}.authors=${IMAGE_AUTHORS}"} \
        ${IMAGE_URL:+--label "${oci}.url=${IMAGE_URL}"} \
        ${IMAGE_DOCUMENTATION:+--label "${oci}.documentation=${IMAGE_DOCUMENTATION}"} \
        ${IMAGE_REVISION:+--label "${oci}.revision=${IMAGE_REVISION}"} \
        ${IMAGE_LICENSES:+--label "${oci}.licenses=${IMAGE_LICENSES}"} \
        ${IMAGE_REF_NAME:+--label "${oci}.ref.name=${IMAGE_REF_NAME}"} \
        ${IMAGE_DESCRIPTION:+--label "${oci}.description=${IMAGE_DESCRIPTION}"}

Build and Push with buildx:
  image: docker:19.03
  stage: build_and_publish
  services:
    - name: docker:19.03-dind
      command: ["--experimental"]
  before_script:
    - mkdir -p ~/.docker/cli-plugins
    - mv buildx ~/.docker/cli-plugins/docker-buildx
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
  script:
    - echo docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker buildx create --use --name mybuilder
#    - docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 --push -t $CI_REGISTRY_IMAGE .
    - docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t $CI_REGISTRY_IMAGE .
